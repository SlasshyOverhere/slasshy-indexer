<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slasshy Player</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #030014;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .player-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #030014;
        }

        .player-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Premium Loading Overlay with 3D Effects */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #030014 0%, #0c0a1d 30%, #1a0f2e 60%, #0c0a1d 80%, #030014 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .loading-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(139, 92, 246, 0.05) 0%, transparent 70%);
            pointer-events: none;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* 3D Cube Loader */
        .cube-container {
            width: 80px;
            height: 80px;
            perspective: 800px;
            margin-bottom: 40px;
        }

        .cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            animation: cubeRotate 3s ease-in-out infinite;
        }

        .cube-face {
            position: absolute;
            width: 60px;
            height: 60px;
            left: 10px;
            top: 10px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3) 0%, rgba(6, 182, 212, 0.2) 100%);
            border: 2px solid rgba(139, 92, 246, 0.5);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cube-face::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            border-radius: 6px;
        }

        .cube-face.front {
            transform: rotateY(0deg) translateZ(30px);
        }

        .cube-face.back {
            transform: rotateY(180deg) translateZ(30px);
        }

        .cube-face.right {
            transform: rotateY(90deg) translateZ(30px);
        }

        .cube-face.left {
            transform: rotateY(-90deg) translateZ(30px);
        }

        .cube-face.top {
            transform: rotateX(90deg) translateZ(30px);
        }

        .cube-face.bottom {
            transform: rotateX(-90deg) translateZ(30px);
        }

        @keyframes cubeRotate {
            0% {
                transform: rotateX(-20deg) rotateY(0deg);
            }

            50% {
                transform: rotateX(-20deg) rotateY(180deg);
            }

            100% {
                transform: rotateX(-20deg) rotateY(360deg);
            }
        }

        /* Glowing Rings */
        .glow-rings {
            position: absolute;
            width: 200px;
            height: 200px;
            pointer-events: none;
        }

        .glow-ring {
            position: absolute;
            border-radius: 50%;
            border: 2px solid transparent;
            animation: ringPulse 2s ease-out infinite;
        }

        .glow-ring:nth-child(1) {
            inset: 0;
            border-color: rgba(139, 92, 246, 0.3);
            animation-delay: 0s;
        }

        .glow-ring:nth-child(2) {
            inset: -20px;
            border-color: rgba(139, 92, 246, 0.2);
            animation-delay: 0.3s;
        }

        .glow-ring:nth-child(3) {
            inset: -40px;
            border-color: rgba(6, 182, 212, 0.15);
            animation-delay: 0.6s;
        }

        @keyframes ringPulse {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }

            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }

        /* Loading Text with Gradient */
        .loading-text {
            font-size: 16px;
            font-weight: 500;
            letter-spacing: 0.05em;
            background: linear-gradient(90deg, #a78bfa 0%, #06b6d4 50%, #a78bfa 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 2s linear infinite;
        }

        @keyframes gradientShift {
            to {
                background-position: 200% center;
            }
        }

        .title-text {
            margin-top: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 13px;
            font-weight: 400;
            max-width: 350px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Premium Branding */
        .branding {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 101;
        }

        .branding-logo {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .branding-logo svg {
            width: 14px;
            height: 14px;
            fill: white;
        }

        .branding-text {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
        }

        /* Error Container - Premium Style */
        .error-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #030014 0%, #0c0a1d 50%, #030014 100%);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .error-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at center, rgba(239, 68, 68, 0.05) 0%, transparent 70%);
        }

        .error-container.visible {
            display: flex;
        }

        .error-card {
            position: relative;
            padding: 48px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 24px;
            backdrop-filter: blur(20px);
            text-align: center;
            max-width: 420px;
        }

        .error-icon {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            box-shadow: 0 0 40px rgba(239, 68, 68, 0.2);
        }

        .error-icon svg {
            width: 36px;
            height: 36px;
            color: #f87171;
        }

        .error-title {
            color: #fff;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .error-message {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            line-height: 1.6;
        }

        /* Progress Indicator - 3D Glass Effect */
        .progress-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.9) 0%, rgba(6, 182, 212, 0.9) 100%);
            color: white;
            padding: 14px 24px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
            z-index: 102;
            opacity: 0;
            transform: translateY(20px) scale(0.9);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            box-shadow:
                0 8px 32px rgba(139, 92, 246, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            backdrop-filter: blur(10px);
        }

        .progress-indicator::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
            pointer-events: none;
        }

        .progress-indicator.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        /* Debug Panel - Modern Style */
        .debug-panel {
            position: fixed;
            top: 16px;
            left: 16px;
            background: rgba(0, 0, 0, 0.85);
            color: #10b981;
            padding: 16px;
            font-size: 11px;
            font-family: 'Fira Code', 'Consolas', monospace;
            border-radius: 12px;
            border: 1px solid rgba(16, 185, 129, 0.3);
            z-index: 103;
            max-width: 320px;
            display: none;
            backdrop-filter: blur(10px);
        }

        .debug-panel.visible {
            display: block;
        }

        /* Floating Particles */
        .particles {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(139, 92, 246, 0.5);
            border-radius: 50%;
            animation: floatUp 8s linear infinite;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translateY(-100vh) scale(1);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <!-- Floating Particles -->
        <div class="particles" id="particles"></div>

        <!-- Glow Rings -->
        <div class="glow-rings">
            <div class="glow-ring"></div>
            <div class="glow-ring"></div>
            <div class="glow-ring"></div>
        </div>

        <!-- 3D Cube Loader -->
        <div class="cube-container">
            <div class="cube">
                <div class="cube-face front"></div>
                <div class="cube-face back"></div>
                <div class="cube-face right"></div>
                <div class="cube-face left"></div>
                <div class="cube-face top"></div>
                <div class="cube-face bottom"></div>
            </div>
        </div>

        <p class="loading-text">Loading Stream...</p>
        <p class="title-text" id="titleText"></p>

        <div class="branding">
            <div class="branding-logo">
                <svg viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z" />
                </svg>
            </div>
            <span class="branding-text">Slasshy Media</span>
        </div>
    </div>

    <div class="error-container" id="errorContainer">
        <div class="error-card">
            <div class="error-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h2 class="error-title">Stream Unavailable</h2>
            <p class="error-message">The streaming URL is invalid or missing required parameters. Please go back and try
                again.</p>
        </div>
    </div>

    <div class="player-container" id="playerContainer">
        <!-- Iframe will be injected here -->
    </div>

    <div class="progress-indicator" id="progressIndicator">
        <span id="progressText">Progress saved</span>
    </div>

    <div class="debug-panel" id="debugPanel">
        <div id="debugContent"></div>
    </div>

    <script>
        (function () {
            // Generate floating particles for visual effect
            const particlesContainer = document.getElementById('particles');
            if (particlesContainer) {
                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 8 + 's';
                    particle.style.animationDuration = (6 + Math.random() * 4) + 's';
                    particle.style.width = (2 + Math.random() * 4) + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.background = Math.random() > 0.5
                        ? 'rgba(139, 92, 246, ' + (0.3 + Math.random() * 0.4) + ')'
                        : 'rgba(6, 182, 212, ' + (0.3 + Math.random() * 0.4) + ')';
                    particlesContainer.appendChild(particle);
                }
            }

            const VIDEASY_BASE = 'https://player.videasy.net';
            const STORAGE_KEY = 'slasshy_streaming_progress';
            const PRIMARY_COLOR = '8B5CF6'; // Slasshy purple without #

            // Parse URL parameters
            const params = new URLSearchParams(window.location.search);
            const type = params.get('type'); // 'movie' or 'tv'
            const id = params.get('id');     // TMDB ID
            const season = params.get('s');  // Season number (for TV)
            const episode = params.get('e'); // Episode number (for TV)
            const title = params.get('title') || 'Stream';
            const poster = params.get('poster'); // Optional poster path
            const startTime = params.get('start'); // Resume position in seconds (optional)
            const resumeMode = params.get('resume'); // 'auto' to load from localStorage
            const debug = params.get('debug') === 'true'; // Debug mode

            // Get unique key for this content
            function getProgressKey() {
                if (type === 'movie') {
                    return `movie_${id}`;
                } else {
                    return `tv_${id}_s${season || 1}_e${episode || 1}`;
                }
            }

            // Get resume position from localStorage
            function getResumePosition() {
                if (startTime === '0') {
                    // Explicit start=0 means start fresh, clear saved progress for this content
                    try {
                        const stored = localStorage.getItem(STORAGE_KEY);
                        if (stored) {
                            const allProgress = JSON.parse(stored);
                            const key = getProgressKey();
                            if (allProgress[key]) {
                                delete allProgress[key];
                                localStorage.setItem(STORAGE_KEY, JSON.stringify(allProgress));
                                console.log('[Player] Cleared progress for fresh start');
                            }
                        }
                    } catch (e) {
                        console.error('[Player] Failed to clear progress:', e);
                    }
                    return 0;
                }

                if (resumeMode === 'auto') {
                    // Try to load from localStorage
                    try {
                        const stored = localStorage.getItem(STORAGE_KEY);
                        if (stored) {
                            const allProgress = JSON.parse(stored);
                            const key = getProgressKey();
                            if (allProgress[key] && allProgress[key].position > 30) {
                                console.log('[Player] Auto-resuming from localStorage:', allProgress[key].position);
                                return allProgress[key].position;
                            }
                        }
                    } catch (e) {
                        console.error('[Player] Failed to load progress for auto-resume:', e);
                    }
                    return 0;
                }

                // Explicit start time from URL
                if (startTime && parseFloat(startTime) > 0) {
                    return parseFloat(startTime);
                }

                return 0;
            }

            const resumePosition = getResumePosition();

            // Current playback state
            let currentProgress = {
                tmdb_id: id,
                media_type: type,
                title: title,
                poster_path: poster || null,
                season: season ? parseInt(season) : null,
                episode: episode ? parseInt(episode) : null,
                position: resumePosition,
                duration: 0,
                progress_percent: 0,
                last_updated: Date.now()
            };

            let lastSaveTime = 0;
            const SAVE_INTERVAL = 10; // Save every 10 seconds of playback

            // Update title
            document.title = `${title} - Slasshy Player`;
            document.getElementById('titleText').textContent = title;

            // Debug mode
            if (debug) {
                document.getElementById('debugPanel').classList.add('visible');
                updateDebug('Initializing...');
            }

            function updateDebug(message) {
                if (!debug) return;
                const content = document.getElementById('debugContent');
                content.innerHTML = `
                    <div>Type: ${type}</div>
                    <div>ID: ${id}</div>
                    <div>Season: ${season || 'N/A'}</div>
                    <div>Episode: ${episode || 'N/A'}</div>
                    <div>Start: ${startTime || '0'}s</div>
                    <hr style="margin: 5px 0; border-color: #333;">
                    <div>Position: ${currentProgress.position.toFixed(1)}s</div>
                    <div>Duration: ${currentProgress.duration.toFixed(1)}s</div>
                    <div>Progress: ${currentProgress.progress_percent.toFixed(1)}%</div>
                    <hr style="margin: 5px 0; border-color: #333;">
                    <div style="color: #8b5cf6;">${message}</div>
                `;
            }

            // Validate parameters
            if (!type || !id) {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('errorContainer').classList.add('visible');
                return;
            }


            // Save progress to localStorage
            function saveProgress(showIndicator = true) {
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    const allProgress = stored ? JSON.parse(stored) : {};

                    const key = getProgressKey();
                    currentProgress.last_updated = Date.now();

                    // Calculate progress percent
                    if (currentProgress.duration > 0) {
                        currentProgress.progress_percent = (currentProgress.position / currentProgress.duration) * 100;
                    }

                    allProgress[key] = currentProgress;

                    // Keep only last 100 entries
                    const keys = Object.keys(allProgress);
                    if (keys.length > 100) {
                        const sortedKeys = keys.sort((a, b) =>
                            allProgress[b].last_updated - allProgress[a].last_updated
                        );
                        const newProgress = {};
                        sortedKeys.slice(0, 100).forEach(k => {
                            newProgress[k] = allProgress[k];
                        });
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(newProgress));
                    } else {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(allProgress));
                    }

                    console.log('[Player] Progress saved:', currentProgress);
                    updateDebug('Progress saved!');

                    if (showIndicator) {
                        showProgressIndicator(`Progress saved: ${formatTime(currentProgress.position)}`);
                    }
                } catch (e) {
                    console.error('[Player] Failed to save progress:', e);
                    updateDebug('Save failed: ' + e.message);
                }
            }

            // Format seconds as MM:SS or HH:MM:SS
            function formatTime(seconds) {
                const hrs = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);

                if (hrs > 0) {
                    return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // Show progress indicator with custom message
            function showProgressIndicator(message) {
                const indicator = document.getElementById('progressIndicator');
                const text = document.getElementById('progressText');
                text.textContent = message || 'Progress saved';
                indicator.classList.add('visible');
                setTimeout(() => {
                    indicator.classList.remove('visible');
                }, 2500);
            }

            // Listen for postMessage from Videasy iframe
            window.addEventListener('message', function (event) {
                // Log all messages for debugging
                console.log('[Player] Message received:', event.origin, event.data);
                updateDebug('Message from: ' + event.origin);

                try {
                    const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;

                    // Check for progress data from Videasy
                    // Videasy sends: id, type, progress, timestamp, duration, season, episode
                    if (data && typeof data.timestamp === 'number' && typeof data.duration === 'number') {
                        currentProgress.position = data.timestamp;
                        currentProgress.duration = data.duration;

                        if (data.progress !== undefined) {
                            currentProgress.progress_percent = data.progress;
                        } else if (data.duration > 0) {
                            currentProgress.progress_percent = (data.timestamp / data.duration) * 100;
                        }

                        console.log('[Player] Progress update:', {
                            position: currentProgress.position,
                            duration: currentProgress.duration,
                            percent: currentProgress.progress_percent
                        });

                        updateDebug('Progress: ' + currentProgress.progress_percent.toFixed(1) + '%');

                        // Save every SAVE_INTERVAL seconds
                        if (Math.abs(data.timestamp - lastSaveTime) >= SAVE_INTERVAL) {
                            lastSaveTime = data.timestamp;
                            saveProgress(false); // Don't show indicator for auto-saves
                        }
                    }
                } catch (e) {
                    // Ignore non-JSON messages
                    console.log('[Player] Non-JSON message:', event.data);
                }
            });

            // Build Videasy URL with all features
            let playerUrl;
            const queryParams = new URLSearchParams();

            // Add Slasshy brand color
            queryParams.set('color', PRIMARY_COLOR);

            // Add Netflix-style overlay
            queryParams.set('overlay', 'true');

            if (type === 'movie') {
                playerUrl = `${VIDEASY_BASE}/movie/${id}`;

                // Add start time for resume (from localStorage or explicit)
                if (resumePosition > 0) {
                    queryParams.set('progress', String(Math.floor(resumePosition)));
                    console.log('[Player] Setting movie resume position:', resumePosition);
                }
            } else if (type === 'tv') {
                const s = season || '1';
                const ep = episode || '1';
                playerUrl = `${VIDEASY_BASE}/tv/${id}/${s}/${ep}`;

                // Add TV show specific features
                queryParams.set('nextEpisode', 'true');
                queryParams.set('autoplayNextEpisode', 'true');
                queryParams.set('episodeSelector', 'true');

                // Add start time for resume (from localStorage or explicit)
                if (resumePosition > 0) {
                    queryParams.set('progress', String(Math.floor(resumePosition)));
                    console.log('[Player] Setting TV resume position:', resumePosition);
                }
            } else {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('errorContainer').classList.add('visible');
                return;
            }

            // Append query params
            const queryString = queryParams.toString();
            if (queryString) {
                playerUrl += '?' + queryString;
            }

            console.log('[Player] Loading URL:', playerUrl);
            updateDebug('Loading player...');

            // Create and inject iframe
            const container = document.getElementById('playerContainer');
            const iframe = document.createElement('iframe');
            iframe.src = playerUrl;
            iframe.allow = 'autoplay; fullscreen; picture-in-picture; encrypted-media; accelerometer; gyroscope';
            iframe.allowFullscreen = true;
            iframe.referrerPolicy = 'no-referrer';

            // Hide loading after iframe loads
            iframe.onload = function () {
                setTimeout(function () {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 1000);

                // Initial save to mark as started
                saveProgress(false);
                updateDebug('Player loaded!');
            };

            container.appendChild(iframe);

            // Fallback: hide loading after 5 seconds regardless
            setTimeout(function () {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 5000);

            // Block popups
            window.open = function () { return null; };

            // Save progress before page unload
            window.addEventListener('beforeunload', function () {
                saveProgress(false);
            });

            // Also save on visibility change (tab switch, minimize)
            document.addEventListener('visibilitychange', function () {
                if (document.visibilityState === 'hidden' && currentProgress.position > 0) {
                    saveProgress(false);
                }
            });

            // Periodic save every 30 seconds as backup
            setInterval(function () {
                if (currentProgress.position > 0 && currentProgress.duration > 0) {
                    saveProgress(false);
                }
            }, 30000);

            // Keyboard shortcut: Press 'D' to toggle debug panel
            document.addEventListener('keydown', function (e) {
                if (e.key === 'd' || e.key === 'D') {
                    const panel = document.getElementById('debugPanel');
                    panel.classList.toggle('visible');
                }
            });
        })();
    </script>
</body>

</html>